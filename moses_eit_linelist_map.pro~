; The goal of this procedure is to turn a dem/pix map generated by
; eit_dem_tool and turn it into a chianti linelist/pix map in order to
; recreate a full disk sun image for each spectral line in the MOSES
; passband. 


;list of EIT images from MOSES I lauch
;; f171 = '/home/jake/Documents/MOSES/MCOR/moses_eit/efz20060208.190014'
;; f195 = '/home/jake/Documents/MOSES/MCOR/moses_eit/efz20060208.183429'
;; f284 = '/home/jake/Documents/MOSES/MCOR/moses_eit/efz20060208.182651'
;; f304 = '/home/jake/Documents/MOSES/MCOR/moses_eit/efz20060208.184020';


;read in EIT images and build a dem map

restore, 'eit_cube_prepped.sav'

eit_dem_tool,eit_cube,dem_map,dem_logt


;prepare to generate line_lists

wmin = 280
wmax = 340
pressure = 1e15
ioneq_name = '/usr/local/ssw/packages/chianti/dbase/ioneq/chianti.ioneq'

;since ch_synthetic uses EM and not DEM in Isothermal mode we need to
;prepare an array of dt to multiply intensities before
;integrating. I don't know why there is a natural log, but this
;copied from chianti ch_synthetic

temp = 10.^dem_logt
dlnt=ALOG(10.^(dem_logt[1]-dem_logt[0]))
dt=temp * dlnt

;generate an isothermal line list over the range of wavelengths we
;care about, at a constant pressure

ch_synthetic, wmin, wmax, pressure=pressure,logt_isothermal = dem_logt, ioneq_name = ioneq_name,$
              output = line_list, /no_sum_int



;; ;build line list map
;; dt_len = n_elements(dt)
;; dt = rebin(reform(dt,1,1,dt_len),1024,1024,dt_len)
;; eit_linelist_map = fltarr(1024,1024,n_elements(line_list.lines))

;; for i = 0,n_elements(line_list.lines)-1 do begin
;;    print,i
;;    int_map = rebin(reform(line_list.lines[i].int,1,1,dt_len),1024,1024,dt_len)
;;    eit_linelist_map[0,0,i] = total(int_map*10.^dem_map*dt,3)

;; endfor
   
save,dem_map,dem_logt,line_list,filename = 'linelist_map_guts.sav'


;; STOP

;; save,eit_linelist_map,line_list,filename = 'eit_linelist_map.sav'





     



end
